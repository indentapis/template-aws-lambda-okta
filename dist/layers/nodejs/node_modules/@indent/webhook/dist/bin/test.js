#!/usr/bin/env node
var _this = this;
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var default_1 = tslib_1.__importDefault(require("../config/default"));
var index_1 = require("../index");
var node_fetch_1 = tslib_1.__importDefault(require("node-fetch"));
var path_1 = tslib_1.__importDefault(require("path"));
var arg_1 = tslib_1.__importDefault(require("arg"));
var fs_1 = tslib_1.__importDefault(require("fs"));
// indent-webhook-test
var args = arg_1.default({
    '-c': String,
    '--url': String,
    '--config': String,
    '--help': Boolean,
    '-h': Boolean
});
var showHelp = function () {
    return console.log("\nUsage: indent-webhook-test --url=[url] --config,-c=[config] <url>\n\n--url        <url>     URL to work with for testing\n--config, -c <config>  File path of test config, https://indent.fyi/indent-js/webhook-test-config\n".trim());
};
var _a = tslib_1.__read(args._, 1), _b = _a[0], url = _b === void 0 ? '' : _b;
if (!url) {
    url = args['--url'] || '';
}
if (args['--help'] || args['-h'] || url === 'help') {
    showHelp();
    process.exit(0);
}
var configPath = args['--config'] || args['-c'] || '';
var config = default_1.default;
if (configPath) {
    try {
        config = JSON.parse(fs_1.default.readFileSync(path_1.default.resolve(process.cwd(), configPath)).toString());
    }
    catch (_err) { }
}
if (!url) {
    showHelp();
    process.exit(1);
}
var hook = config.hook;
var timestamp = function () { return new Date().toISOString(); };
var sleep = function (d) { return new Promise(function (resolve) { return setTimeout(resolve, d); }); };
if (!hook) {
    console.error('Error: missing `hook` field in config, should be object like `{"hook":{"secret":"123"}}`');
    process.exit(1);
}
var complete = Promise.all(config.entries.map(function (cfg) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
    var body, ts, signature, err_1;
    return tslib_1.__generator(this, function (_a) {
        switch (_a.label) {
            case 0:
                body = JSON.stringify({
                    events: cfg.events
                });
                return [4 /*yield*/, sleep(cfg.delay || 0)];
            case 1:
                _a.sent();
                ts = timestamp();
                return [4 /*yield*/, index_1.sign({
                        secret: hook.secret,
                        payload: index_1.getSignaturePayload({
                            timestamp: ts,
                            body: body
                        })
                    })];
            case 2:
                signature = _a.sent();
                _a.label = 3;
            case 3:
                _a.trys.push([3, 5, , 6]);
                return [4 /*yield*/, node_fetch_1.default(hook.url || url, {
                        method: hook.method || 'post',
                        headers: tslib_1.__assign(tslib_1.__assign({}, hook.headers), { 'X-Indent-Timestamp': ts, 'X-Indent-Signature': signature }),
                        body: body
                    })];
            case 4:
                _a.sent();
                return [2 /*return*/, null];
            case 5:
                err_1 = _a.sent();
                throw err_1;
            case 6: return [2 /*return*/];
        }
    });
}); }));
complete
    .then(function () { return console.log('done!'); })
    .catch(function (err) {
    console.error(err);
});
//# sourceMappingURL=test.js.map